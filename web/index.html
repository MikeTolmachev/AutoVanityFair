<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenLinkedIn</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,600;1,6..72,400&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ============================================================
   CSS RESET & VARIABLES
   ============================================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-0: #08090C;
  --bg-1: #0F1116;
  --bg-2: #171A21;
  --bg-3: #1F2330;
  --bg-4: #282D3A;
  --accent: #C9A84C;
  --accent-hover: #DDC06A;
  --accent-muted: rgba(201, 168, 76, 0.10);
  --accent-glow: rgba(201, 168, 76, 0.25);
  --text-0: #F0EDE5;
  --text-1: #B0ADA5;
  --text-2: #6B6E76;
  --success: #34D399;
  --success-bg: rgba(52, 211, 153, 0.08);
  --warning: #FBBF24;
  --warning-bg: rgba(251, 191, 36, 0.08);
  --error: #F87171;
  --error-bg: rgba(248, 113, 113, 0.08);
  --info: #60A5FA;
  --info-bg: rgba(96, 165, 250, 0.08);
  --border: rgba(255, 255, 255, 0.06);
  --border-accent: rgba(201, 168, 76, 0.25);
  --radius: 10px;
  --radius-sm: 6px;
  --sidebar-w: 250px;
  --font-heading: 'Newsreader', Georgia, serif;
  --font-body: 'Outfit', system-ui, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

html { font-size: 15px; }

body {
  font-family: var(--font-body);
  background: var(--bg-0);
  color: var(--text-0);
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Grain texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
  opacity: 0.025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
}

a { color: var(--accent); text-decoration: none; }
a:hover { color: var(--accent-hover); }

/* ============================================================
   LAYOUT
   ============================================================ */
.app-layout {
  display: flex;
  min-height: 100vh;
}

/* SIDEBAR */
.sidebar {
  position: fixed;
  top: 0; left: 0; bottom: 0;
  width: var(--sidebar-w);
  background: var(--bg-1);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  z-index: 100;
  overflow-y: auto;
}

.sidebar-logo {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}

.sidebar-logo h1 {
  font-family: var(--font-heading);
  font-size: 1.55rem;
  font-weight: 600;
  color: var(--text-0);
  letter-spacing: -0.02em;
}

.sidebar-logo h1 span { color: var(--accent); }

.sidebar-logo p {
  font-size: 0.72rem;
  color: var(--text-2);
  margin-top: 3px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.sidebar-nav {
  padding: 16px 12px;
  flex: 1;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  color: var(--text-1);
  font-size: 0.88rem;
  font-weight: 400;
  cursor: pointer;
  transition: var(--transition);
  border: 1px solid transparent;
}

.nav-item:hover {
  background: var(--bg-2);
  color: var(--text-0);
}

.nav-item.active {
  background: var(--accent-muted);
  color: var(--accent);
  border-color: var(--border-accent);
  font-weight: 500;
}

.nav-item svg {
  width: 18px; height: 18px;
  opacity: 0.7;
  flex-shrink: 0;
}

.nav-item.active svg { opacity: 1; }

.nav-section-label {
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--text-2);
  padding: 20px 14px 6px;
}

/* Sidebar stats */
.sidebar-stats {
  padding: 16px 14px;
  border-top: 1px solid var(--border);
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 0;
  font-size: 0.78rem;
}

.stat-row .label { color: var(--text-2); }
.stat-row .value { color: var(--text-0); font-weight: 500; font-family: var(--font-mono); font-size: 0.75rem; }

/* MAIN CONTENT */
.main-content {
  margin-left: var(--sidebar-w);
  flex: 1;
  padding: 32px 40px 60px;
  min-height: 100vh;
}

/* ============================================================
   PAGE HEADER
   ============================================================ */
.page-header {
  margin-bottom: 32px;
  animation: fadeIn 0.4s ease;
}

.page-header h2 {
  font-family: var(--font-heading);
  font-size: 2rem;
  font-weight: 600;
  letter-spacing: -0.03em;
  color: var(--text-0);
}

.page-header p {
  color: var(--text-2);
  font-size: 0.88rem;
  margin-top: 4px;
}

/* ============================================================
   CARDS
   ============================================================ */
.card {
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  transition: var(--transition);
}

.card:hover {
  border-color: rgba(255,255,255,0.1);
}

.card-grid {
  display: grid;
  gap: 16px;
}

.card-grid-4 { grid-template-columns: repeat(4, 1fr); }
.card-grid-3 { grid-template-columns: repeat(3, 1fr); }
.card-grid-2 { grid-template-columns: repeat(2, 1fr); }

/* Metric cards */
.metric-card {
  text-align: center;
  padding: 20px 16px;
}

.metric-card .metric-value {
  font-family: var(--font-mono);
  font-size: 1.8rem;
  font-weight: 500;
  color: var(--text-0);
  line-height: 1;
}

.metric-card .metric-label {
  font-size: 0.75rem;
  color: var(--text-2);
  margin-top: 8px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.metric-card.accent .metric-value { color: var(--accent); }
.metric-card.success .metric-value { color: var(--success); }
.metric-card.info .metric-value { color: var(--info); }

/* ============================================================
   BUTTONS
   ============================================================ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 7px;
  padding: 8px 18px;
  border-radius: var(--radius-sm);
  font-family: var(--font-body);
  font-size: 0.82rem;
  font-weight: 500;
  cursor: pointer;
  border: 1px solid transparent;
  transition: var(--transition);
  white-space: nowrap;
}

.btn-primary {
  background: var(--accent);
  color: #0A0C10;
  border-color: var(--accent);
}
.btn-primary:hover {
  background: var(--accent-hover);
  border-color: var(--accent-hover);
  transform: translateY(-1px);
  box-shadow: 0 4px 16px var(--accent-glow);
}

.btn-secondary {
  background: var(--bg-3);
  color: var(--text-0);
  border-color: var(--border);
}
.btn-secondary:hover {
  background: var(--bg-4);
  border-color: rgba(255,255,255,0.12);
}

.btn-success {
  background: var(--success-bg);
  color: var(--success);
  border-color: rgba(52, 211, 153, 0.2);
}
.btn-success:hover { border-color: var(--success); }

.btn-danger {
  background: var(--error-bg);
  color: var(--error);
  border-color: rgba(248, 113, 113, 0.2);
}
.btn-danger:hover { border-color: var(--error); }

.btn-sm { padding: 5px 12px; font-size: 0.76rem; }
.btn-block { width: 100%; justify-content: center; }

.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none !important;
}

/* ============================================================
   FORM ELEMENTS
   ============================================================ */
select, input[type="text"], input[type="number"], textarea {
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-0);
  font-family: var(--font-body);
  font-size: 0.85rem;
  padding: 9px 14px;
  width: 100%;
  outline: none;
  transition: var(--transition);
}

select:focus, input:focus, textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-muted);
}

textarea { resize: vertical; min-height: 80px; }

label {
  display: block;
  font-size: 0.76rem;
  color: var(--text-2);
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.form-row {
  display: flex;
  gap: 16px;
  align-items: flex-end;
}

.form-group { margin-bottom: 16px; }

/* ============================================================
   STATUS BADGES
   ============================================================ */
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 99px;
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.badge-draft { background: var(--info-bg); color: var(--info); }
.badge-approved { background: var(--success-bg); color: var(--success); }
.badge-published { background: rgba(167, 139, 250, 0.1); color: #A78BFA; }
.badge-rejected { background: var(--error-bg); color: var(--error); }

/* ============================================================
   CONTENT CARDS (posts, comments, feed items)
   ============================================================ */
.content-card {
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 22px;
  margin-bottom: 12px;
  transition: var(--transition);
  animation: slideUp 0.3s ease both;
}

.content-card:hover {
  border-color: rgba(255,255,255,0.1);
}

.content-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.content-card-meta {
  font-size: 0.76rem;
  color: var(--text-2);
}

.content-card-body {
  font-size: 0.9rem;
  color: var(--text-1);
  line-height: 1.65;
  margin-bottom: 14px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.content-card-body.truncate {
  display: -webkit-box;
  -webkit-line-clamp: 6;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.content-card-footer {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.content-card-footer .char-count {
  margin-left: auto;
  font-size: 0.72rem;
  color: var(--text-2);
  font-family: var(--font-mono);
}

/* Score badge */
.score {
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 0.88rem;
}

.score-high { color: var(--success); }
.score-mid { color: var(--warning); }
.score-low { color: var(--error); }

/* ============================================================
   FILTER BAR
   ============================================================ */
.filter-bar {
  display: flex;
  gap: 12px;
  align-items: flex-end;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.filter-bar .filter-group label {
  margin-bottom: 4px;
}

.filter-bar select, .filter-bar input {
  width: auto;
  min-width: 140px;
}

/* ============================================================
   TOAST NOTIFICATIONS
   ============================================================ */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 20px;
  font-size: 0.84rem;
  color: var(--text-0);
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
  max-width: 360px;
}

.toast.success { border-left: 3px solid var(--success); }
.toast.error { border-left: 3px solid var(--error); }
.toast.info { border-left: 3px solid var(--info); }

/* ============================================================
   MODAL
   ============================================================ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.2s ease;
}

.modal {
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 28px;
  width: 90%;
  max-width: 640px;
  max-height: 85vh;
  overflow-y: auto;
  animation: scaleIn 0.25s ease;
}

.modal h3 {
  font-family: var(--font-heading);
  font-size: 1.3rem;
  margin-bottom: 20px;
}

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 24px;
}

/* ============================================================
   TABS
   ============================================================ */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: 24px;
}

.tab {
  padding: 10px 20px;
  font-size: 0.84rem;
  color: var(--text-2);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: var(--transition);
}

.tab:hover { color: var(--text-0); }
.tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

/* ============================================================
   EMPTY STATE
   ============================================================ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-2);
}

.empty-state svg {
  width: 48px; height: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state p { font-size: 0.9rem; margin-top: 8px; }

/* ============================================================
   LOADING
   ============================================================ */
.spinner {
  width: 28px; height: 28px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 40px auto;
}

.loading-overlay {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 60px;
}

/* ============================================================
   BAR CHART
   ============================================================ */
.bar-chart {
  display: flex;
  gap: 8px;
  align-items: flex-end;
  height: 140px;
  padding: 12px 0;
}

.bar-chart .bar-col {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  justify-content: flex-end;
}

.bar-chart .bar {
  width: 100%;
  max-width: 60px;
  background: var(--accent-muted);
  border: 1px solid var(--border-accent);
  border-radius: 4px 4px 0 0;
  min-height: 4px;
  transition: height 0.5s ease;
}

.bar-chart .bar-label {
  font-size: 0.65rem;
  color: var(--text-2);
  margin-top: 6px;
  text-align: center;
}

.bar-chart .bar-value {
  font-size: 0.7rem;
  color: var(--text-1);
  font-family: var(--font-mono);
  margin-bottom: 4px;
}

/* ============================================================
   FEED ITEM CARD
   ============================================================ */
.feed-card {
  position: relative;
}

.feed-card.liked { border-left: 3px solid var(--success); }
.feed-card.disliked { border-left: 3px solid var(--error); opacity: 0.5; }

.feed-card.dismissing {
  animation: dismissCard 0.45s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  pointer-events: none;
}

.feed-keywords {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.keyword-tag {
  font-size: 0.66rem;
  padding: 2px 8px;
  border-radius: 99px;
  background: var(--bg-4);
  color: var(--text-2);
}

/* ============================================================
   ANIMATIONS
   ============================================================ */
@keyframes fadeIn {
  from { opacity: 0; } to { opacity: 1; }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideInRight {
  from { opacity: 0; transform: translateX(40px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes fadeOut {
  to { opacity: 0; transform: translateY(-10px); }
}

@keyframes scaleIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes dismissCard {
  0%   { opacity: 1; transform: translateX(0) scale(1); max-height: 600px; margin-bottom: 12px; }
  40%  { opacity: 0.6; transform: translateX(30px) scale(0.98); }
  100% { opacity: 0; transform: translateX(80px) scale(0.95); max-height: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; border-width: 0; overflow: hidden; }
}

/* Staggered card entry */
.content-card:nth-child(1) { animation-delay: 0.02s; }
.content-card:nth-child(2) { animation-delay: 0.05s; }
.content-card:nth-child(3) { animation-delay: 0.08s; }
.content-card:nth-child(4) { animation-delay: 0.11s; }
.content-card:nth-child(5) { animation-delay: 0.14s; }
.content-card:nth-child(6) { animation-delay: 0.17s; }
.content-card:nth-child(7) { animation-delay: 0.2s; }
.content-card:nth-child(8) { animation-delay: 0.23s; }

/* ============================================================
   SCROLLBAR
   ============================================================ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg-4); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-2); }

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media (max-width: 1100px) {
  .card-grid-4 { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main-content { margin-left: 0; padding: 20px; }
  .card-grid-4, .card-grid-3 { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="app-layout">
  <!-- ============================================================
       SIDEBAR
       ============================================================ -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <h1>Open<span>LinkedIn</span></h1>
      <p>Content Command Center</p>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section-label">Workflow</div>

      <div class="nav-item active" data-page="dashboard" onclick="navigate('dashboard')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </div>

      <div class="nav-item" data-page="feeds" onclick="navigate('feeds')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>
        Feed Aggregator
      </div>

      <div class="nav-item" data-page="library" onclick="navigate('library')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
        Content Library
      </div>

      <div class="nav-item" data-page="posts" onclick="navigate('posts')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        Posts Queue
      </div>

      <div class="nav-item" data-page="comments" onclick="navigate('comments')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Comments
      </div>

      <div class="nav-section-label">Insights</div>

      <div class="nav-item" data-page="analytics" onclick="navigate('analytics')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        Analytics
      </div>

      <div class="nav-item" data-page="settings" onclick="navigate('settings')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        Settings
      </div>
    </nav>

    <div class="sidebar-stats" id="sidebar-stats">
      <div class="stat-row">
        <span class="label">Drafts</span>
        <span class="value" id="stat-drafts">--</span>
      </div>
      <div class="stat-row">
        <span class="label">Approved</span>
        <span class="value" id="stat-approved">--</span>
      </div>
      <div class="stat-row">
        <span class="label">Published</span>
        <span class="value" id="stat-published">--</span>
      </div>
      <div class="stat-row">
        <span class="label">Comments Today</span>
        <span class="value" id="stat-comments">--</span>
      </div>
    </div>
  </aside>

  <!-- ============================================================
       MAIN CONTENT
       ============================================================ -->
  <main class="main-content" id="main-content">
    <div class="loading-overlay"><div class="spinner"></div></div>
  </main>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toast-container"></div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
/* =============================================================
   API HELPERS
   ============================================================= */
const API = '/api';

function getToken() {
  return localStorage.getItem('openlinkedin_token') || '';
}

function promptForToken() {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal">
      <h3>Authentication Required</h3>
      <p style="color:var(--text-2);font-size:0.84rem;margin-bottom:16px">Enter your API token (OPENLINKEDIN_API_TOKEN).</p>
      <div class="form-group">
        <label>API Token</label>
        <input type="password" id="auth-token-input" placeholder="Paste your token here">
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="saveToken()">Authenticate</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  document.getElementById('auth-token-input')?.focus();
}

function saveToken() {
  const token = document.getElementById('auth-token-input')?.value?.trim();
  if (token) {
    localStorage.setItem('openlinkedin_token', token);
    document.querySelector('.modal-overlay')?.remove();
    navigate(currentPage);
    refreshSidebarStats();
  }
}

async function api(path, opts = {}) {
  const url = API + path;
  const headers = { 'Content-Type': 'application/json' };
  const token = getToken();
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const config = { headers, ...opts };
  if (config.body && typeof config.body === 'object') {
    config.body = JSON.stringify(config.body);
  }
  const res = await fetch(url, config);
  if (res.status === 401) {
    promptForToken();
    throw new Error('Authentication required');
  }
  if (!res.ok) {
    const err = await res.json().catch(() => ({ detail: res.statusText }));
    throw new Error(err.detail || `HTTP ${res.status}`);
  }
  return res.json();
}

function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

function scoreClass(score) {
  if (score >= 30) return 'score-high';
  if (score >= 15) return 'score-mid';
  return 'score-low';
}

function badgeClass(status) {
  return `badge badge-${status}`;
}

function truncate(str, len = 300) {
  if (!str) return '';
  return str.length > len ? str.slice(0, len) + '...' : str;
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function safeUrl(url) {
  if (!url) return '#';
  try { const u = new URL(url); return ['http:', 'https:'].includes(u.protocol) ? url : '#'; }
  catch { return '#'; }
}

/* =============================================================
   NAVIGATION / ROUTER
   ============================================================= */
let currentPage = 'dashboard';

function navigate(page) {
  currentPage = page;
  document.querySelectorAll('.nav-item').forEach(el => {
    el.classList.toggle('active', el.dataset.page === page);
  });
  renderPage(page);
}

async function renderPage(page) {
  const main = document.getElementById('main-content');
  main.innerHTML = '<div class="loading-overlay"><div class="spinner"></div></div>';
  try {
    switch (page) {
      case 'dashboard': await renderDashboard(main); break;
      case 'feeds': await renderFeeds(main); break;
      case 'library': await renderLibrary(main); break;
      case 'posts': await renderPosts(main); break;
      case 'comments': await renderComments(main); break;
      case 'analytics': await renderAnalytics(main); break;
      case 'settings': await renderSettings(main); break;
    }
  } catch (e) {
    main.innerHTML = `<div class="empty-state"><p style="color:var(--error)">Error loading page: ${escapeHtml(e.message)}</p></div>`;
  }
}

/* =============================================================
   SIDEBAR STATS
   ============================================================= */
async function refreshSidebarStats() {
  try {
    const stats = await api('/stats');
    document.getElementById('stat-drafts').textContent = stats.posts.draft || 0;
    document.getElementById('stat-approved').textContent = stats.posts.approved || 0;
    document.getElementById('stat-published').textContent = stats.posts.published || 0;
    document.getElementById('stat-comments').textContent = stats.comments_today || 0;
  } catch(e) { /* silent */ }
}

/* =============================================================
   DASHBOARD
   ============================================================= */
async function renderDashboard(el) {
  const stats = await api('/stats');
  const logs = await api('/logs?limit=10');

  el.innerHTML = `
    <div class="page-header">
      <h2>Dashboard</h2>
      <p>Your content operations at a glance</p>
    </div>

    <div class="card-grid card-grid-4" style="margin-bottom:28px">
      <div class="card metric-card accent">
        <div class="metric-value">${stats.total_posts || 0}</div>
        <div class="metric-label">Total Posts</div>
      </div>
      <div class="card metric-card success">
        <div class="metric-value">${stats.posts.published || 0}</div>
        <div class="metric-label">Published</div>
      </div>
      <div class="card metric-card info">
        <div class="metric-value">${stats.posts.draft || 0}</div>
        <div class="metric-label">In Queue</div>
      </div>
      <div class="card metric-card">
        <div class="metric-value">${stats.comments_today || 0}</div>
        <div class="metric-label">Comments Today</div>
      </div>
    </div>

    <div class="card-grid card-grid-3" style="margin-bottom:28px">
      <div class="card metric-card">
        <div class="metric-value">${stats.feed_items || 0}</div>
        <div class="metric-label">Feed Items</div>
      </div>
      <div class="card metric-card">
        <div class="metric-value">${stats.library_docs || 0}</div>
        <div class="metric-label">Library Docs</div>
      </div>
      <div class="card metric-card">
        <div class="metric-value">${stats.total_comments || 0}</div>
        <div class="metric-label">Total Comments</div>
      </div>
    </div>

    <div class="card-grid card-grid-2">
      <div class="card">
        <h3 style="font-family:var(--font-heading);font-size:1.15rem;margin-bottom:16px">Quick Actions</h3>
        <div style="display:flex;flex-direction:column;gap:10px">
          <button class="btn btn-primary btn-block" onclick="quickGenerate()">Generate New Post</button>
          <button class="btn btn-secondary btn-block" onclick="navigate('feeds')">Browse Feeds</button>
          <button class="btn btn-secondary btn-block" onclick="navigate('posts')">Review Queue</button>
        </div>
      </div>

      <div class="card">
        <h3 style="font-family:var(--font-heading);font-size:1.15rem;margin-bottom:16px">Recent Activity</h3>
        <div style="max-height:220px;overflow-y:auto">
          ${logs.length ? logs.map(l => `
            <div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:0.78rem">
              <span style="color:${l.status==='success' ? 'var(--success)' : 'var(--error)'}">${l.status === 'success' ? '+' : 'x'}</span>
              <span style="color:var(--text-2)">${escapeHtml(l.created_at || '')}</span>
              <span style="color:var(--text-1);font-weight:500"> ${escapeHtml(l.action_type)}</span>
              <span style="color:var(--text-2)"> ${escapeHtml(l.details || '')}</span>
            </div>
          `).join('') : '<p style="color:var(--text-2);font-size:0.84rem">No activity yet.</p>'}
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:20px">
      <h3 style="font-family:var(--font-heading);font-size:1.15rem;margin-bottom:12px">Safety Monitor</h3>
      <div style="display:flex;gap:32px;flex-wrap:wrap">
        <div>
          <span style="font-size:0.72rem;color:var(--text-2);text-transform:uppercase;letter-spacing:0.06em">Hourly</span>
          <div style="font-family:var(--font-mono);font-size:1.1rem;color:var(--text-0)">${stats.safety.hourly_remaining ?? '?'}</div>
        </div>
        <div>
          <span style="font-size:0.72rem;color:var(--text-2);text-transform:uppercase;letter-spacing:0.06em">Daily</span>
          <div style="font-family:var(--font-mono);font-size:1.1rem;color:var(--text-0)">${stats.safety.daily_remaining ?? '?'}</div>
        </div>
        <div>
          <span style="font-size:0.72rem;color:var(--text-2);text-transform:uppercase;letter-spacing:0.06em">Weekly</span>
          <div style="font-family:var(--font-mono);font-size:1.1rem;color:var(--text-0)">${stats.safety.weekly_remaining ?? '?'}</div>
        </div>
        <div>
          <span style="font-size:0.72rem;color:var(--text-2);text-transform:uppercase;letter-spacing:0.06em">Error Rate</span>
          <div style="font-family:var(--font-mono);font-size:1.1rem;color:${(stats.safety.error_rate||0) > 0.2 ? 'var(--error)' : 'var(--text-0)'}">${((stats.safety.error_rate||0)*100).toFixed(0)}%</div>
        </div>
        ${stats.safety.in_cooldown ? '<div style="color:var(--error);font-weight:600;font-size:0.84rem">COOLDOWN ACTIVE</div>' : ''}
      </div>
    </div>
  `;
}

async function quickGenerate() {
  toast('Generating post...', 'info');
  try {
    const result = await api('/posts/generate', { method: 'POST', body: { topic: 'AI and technology trends', strategy: 'thought_leadership' } });
    toast(`Post #${result.id} created!`, 'success');
    refreshSidebarStats();
    if (currentPage === 'dashboard') navigate('dashboard');
  } catch (e) {
    toast(`Generation failed: ${e.message}`, 'error');
  }
}

/* =============================================================
   FEEDS
   ============================================================= */
async function renderFeeds(el) {
  const items = await api('/feed?limit=100&min_score=0');
  const sources = await api('/feed/sources');

  el.innerHTML = `
    <div class="page-header">
      <h2>Feed Aggregator</h2>
      <p>Aggregate and filter production-focused AI content</p>
    </div>

    <div class="filter-bar">
      <div class="filter-group">
        <label>Min Score</label>
        <input type="number" id="feed-min-score" value="10" min="0" max="50" step="5" style="width:90px">
      </div>
      <div class="filter-group">
        <label>Max Results</label>
        <input type="number" id="feed-max-results" value="100" min="5" max="500" step="10" style="width:90px">
      </div>
      <div class="filter-group">
        <label>Priorities</label>
        <select id="feed-priorities" style="width:160px">
          <option value="1,2">P1 + P2 (Recommended)</option>
          <option value="">All Priorities</option>
          <option value="1">P1: Production AI</option>
          <option value="2">P2: Engineering</option>
          <option value="3">P3: Infrastructure</option>
          <option value="4">P4: Community</option>
        </select>
      </div>
      <div class="filter-group">
        <label>View</label>
        <select id="feed-view" onchange="filterFeedView()">
          <option value="unlabeled">Unlabeled</option>
          <option value="liked">Liked</option>
          <option value="all">All</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="fetchFeeds()">Fetch & Score</button>
      <button class="btn btn-secondary" onclick="retrainModel()">Retrain ML</button>
    </div>

    <div style="display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap">
      <div id="feed-count-display" style="font-size:0.78rem;color:var(--text-2)">Showing ${items.length} items</div>
      <div style="font-size:0.78rem;color:var(--text-2)">Sources: <strong style="color:var(--text-0)">${Object.keys(sources).length}</strong></div>
    </div>

    <div id="feed-items-container"></div>
  `;

  window._feedItems = items;
  // Apply default view filter (unlabeled)
  filterFeedView();
}

function renderFeedItems(items) {
  if (!items.length) return '<div class="empty-state"><p>No feed items. Click "Fetch & Score" to aggregate content.</p></div>';

  return items.map((item, i) => {
    const fb = item.feedback;
    const fbClass = fb === 'liked' ? 'liked' : fb === 'disliked' ? 'disliked' : '';
    const keywords = Array.isArray(item.matched_keywords) ? item.matched_keywords : [];

    return `
      <div class="content-card feed-card ${fbClass}" data-feed-id="${item.id}" style="animation-delay:${Math.min(i * 0.03, 0.3)}s">
        <div class="content-card-header">
          <div style="flex:1">
            <div style="font-weight:600;font-size:0.95rem;margin-bottom:4px">${escapeHtml(item.title)}</div>
            <div class="content-card-meta">
              ${escapeHtml(item.source_name || '')}
              ${item.content_type ? ' &middot; ' + escapeHtml(item.content_type) : ''}
              ${item.author ? ' &middot; ' + escapeHtml(item.author) : ''}
            </div>
          </div>
          <div class="score ${scoreClass(item.final_score || 0)}">${(item.final_score || 0).toFixed(1)}</div>
        </div>
        <div class="content-card-body truncate">${escapeHtml(item.content || '')}</div>
        ${keywords.length ? `<div class="feed-keywords">${keywords.slice(0,8).map(k => `<span class="keyword-tag">${escapeHtml(k)}</span>`).join('')}</div>` : ''}
        <div class="content-card-footer" style="margin-top:12px">
          <button class="btn btn-sm ${fb === 'liked' ? 'btn-success' : 'btn-secondary'}" onclick="feedFeedback(${item.id},'liked',this)">
            ${fb === 'liked' ? 'Liked' : 'Like'}
          </button>
          <button class="btn btn-sm ${fb === 'disliked' ? 'btn-danger' : 'btn-secondary'}" onclick="feedFeedback(${item.id},'disliked',this)">
            ${fb === 'disliked' ? 'Disliked' : 'Dislike'}
          </button>
          <button class="btn btn-sm btn-secondary" onclick="saveFeedToLibrary(${i})">Save to Library</button>
          ${item.url ? `<a href="${escapeHtml(safeUrl(item.url))}" target="_blank" rel="noopener" style="font-size:0.76rem;margin-left:auto">Open article</a>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function filterFeedView() {
  const view = document.getElementById('feed-view')?.value || 'unlabeled';
  const items = window._feedItems || [];
  let filtered;
  if (view === 'liked') filtered = items.filter(i => i.feedback === 'liked');
  else if (view === 'unlabeled') filtered = items.filter(i => !i.feedback);
  else filtered = items;

  const container = document.getElementById('feed-items-container');
  if (container) {
    container.innerHTML = renderFeedItems(filtered);
  }

  // Update the count display if present
  const countEl = document.getElementById('feed-count-display');
  if (countEl) countEl.textContent = `Showing ${filtered.length} of ${items.length} items`;
}

async function fetchFeeds() {
  const minScore = document.getElementById('feed-min-score')?.value || 10;
  const maxResults = document.getElementById('feed-max-results')?.value || 100;
  const priorities = document.getElementById('feed-priorities')?.value || '';
  toast('Fetching feeds...', 'info');
  try {
    const result = await api(`/feed/fetch?min_score=${minScore}&max_results=${maxResults}${priorities ? '&priorities=' + priorities : ''}`, { method: 'POST' });
    toast(`Fetched ${result.fetched} items`, 'success');
    navigate('feeds');
  } catch (e) {
    toast(`Fetch failed: ${e.message}`, 'error');
  }
}

async function feedFeedback(itemId, feedback, btn) {
  try {
    await api(`/feed/${itemId}/feedback`, { method: 'POST', body: { feedback } });

    // Update local data
    const item = (window._feedItems || []).find(i => i.id === itemId);
    if (item) item.feedback = feedback;

    const currentView = document.getElementById('feed-view')?.value || 'unlabeled';

    // In unlabeled view, animate the card away since it's no longer unlabeled
    if (currentView === 'unlabeled') {
      const card = document.querySelector(`[data-feed-id="${itemId}"]`);
      if (card) {
        card.classList.add('dismissing');
        card.addEventListener('animationend', () => card.remove(), { once: true });
      }
      toast(feedback === 'liked' ? 'Liked!' : 'Disliked', 'success');
    } else {
      // In other views, just re-render in place to update button states
      toast(feedback === 'liked' ? 'Liked!' : 'Disliked', 'success');
      filterFeedView();
    }
  } catch (e) {
    toast(`Feedback failed: ${e.message}`, 'error');
  }
}

async function saveFeedToLibrary(index) {
  const item = (window._feedItems || [])[index];
  if (!item) return;
  try {
    const result = await api('/feed/save', {
      method: 'POST',
      body: { title: item.title, content: item.content || '', url: item.url, source_name: item.source_name, content_type: item.content_type },
    });
    toast(`Saved as document #${result.id}`, 'success');
  } catch (e) {
    toast(`Save failed: ${e.message}`, 'error');
  }
}

async function retrainModel() {
  toast('Retraining ML model...', 'info');
  try {
    const result = await api('/feed/retrain', { method: 'POST' });
    if (result.status === 'trained') {
      toast(`Model trained on ${result.total_samples} samples`, 'success');
    } else if (result.status === 'insufficient_data') {
      toast(`Need more feedback (have ${result.samples}, need ${result.min_required})`, 'info');
    } else {
      toast('Training result: ' + JSON.stringify(result), 'info');
    }
  } catch (e) {
    toast(`Retrain failed: ${e.message}`, 'error');
  }
}

/* =============================================================
   CONTENT LIBRARY
   ============================================================= */
async function renderLibrary(el) {
  const docs = await api('/library');

  el.innerHTML = `
    <div class="page-header">
      <h2>Content Library</h2>
      <p>${docs.length} documents &mdash; save articles from feeds, add thoughts, generate posts</p>
    </div>

    <div style="margin-bottom:20px">
      <button class="btn btn-secondary" onclick="showAddDocModal()">Add Document</button>
    </div>

    <div id="library-container">
      ${docs.length ? docs.map((doc, i) => renderLibraryCard(doc, i)).join('') : '<div class="empty-state"><p>No documents yet. Save articles from the Feed Aggregator.</p></div>'}
    </div>
  `;
}

function renderLibraryCard(doc, i) {
  const tags = Array.isArray(doc.tags) ? doc.tags : [];
  const hasPost = !!doc.generated_post;
  const hasThoughts = !!doc.personal_thoughts;

  return `
    <div class="content-card" style="animation-delay:${Math.min(i * 0.03, 0.3)}s">
      <div class="content-card-header">
        <div style="flex:1">
          <div style="font-weight:600;font-size:0.95rem;margin-bottom:4px">${escapeHtml(doc.title)}</div>
          <div class="content-card-meta">
            ${doc.source ? escapeHtml(truncate(doc.source, 60)) : ''}
            ${tags.length ? ' &middot; ' + tags.map(t => escapeHtml(t)).join(', ') : ''}
          </div>
        </div>
        <div style="display:flex;gap:6px">
          ${hasPost ? '<span class="badge badge-approved">Draft Ready</span>' : ''}
          ${hasThoughts ? '<span class="badge badge-draft">Has Thoughts</span>' : ''}
        </div>
      </div>
      <div class="content-card-footer">
        <button class="btn btn-sm btn-primary" onclick="openLibraryDoc(${doc.id})">Open</button>
        <button class="btn btn-sm btn-danger" onclick="deleteLibraryDoc(${doc.id})">Delete</button>
      </div>
    </div>
  `;
}

async function openLibraryDoc(docId) {
  const doc = await api(`/library/${docId}`);
  const main = document.getElementById('main-content');

  main.innerHTML = `
    <div class="page-header">
      <div style="display:flex;gap:12px;align-items:center">
        <button class="btn btn-secondary btn-sm" onclick="navigate('library')">&larr; Back</button>
        <h2 style="font-size:1.5rem">${escapeHtml(doc.title)}</h2>
      </div>
      ${doc.source ? `<p style="margin-top:4px"><a href="${escapeHtml(safeUrl(doc.source))}" target="_blank" rel="noopener">${escapeHtml(truncate(doc.source, 80))}</a></p>` : ''}
    </div>

    <div class="card" style="margin-bottom:20px">
      <h3 style="font-family:var(--font-heading);font-size:1.1rem;margin-bottom:12px">Source Article</h3>
      <div style="font-size:0.85rem;color:var(--text-1);white-space:pre-wrap;max-height:200px;overflow-y:auto;line-height:1.65">${escapeHtml(doc.content)}</div>
    </div>

    <div class="card" style="margin-bottom:20px">
      <h3 style="font-family:var(--font-heading);font-size:1.1rem;margin-bottom:8px">Your Thoughts</h3>
      <p style="font-size:0.76rem;color:var(--text-2);margin-bottom:10px">Write your perspective. The LLM will blend this with the article to create your post.</p>
      <textarea id="doc-thoughts" rows="4" placeholder="e.g. We ran into the same issue when deploying our RAG pipeline...">${escapeHtml(doc.personal_thoughts || '')}</textarea>
      <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="saveThoughts(${doc.id})">Save Thoughts</button>
    </div>

    <div class="card">
      <h3 style="font-family:var(--font-heading);font-size:1.1rem;margin-bottom:12px">LinkedIn Post Draft</h3>
      <button class="btn btn-primary" onclick="generateFromDoc(${doc.id})" id="gen-btn">Generate Post from Article + Thoughts</button>

      <div id="generated-draft" style="margin-top:16px">
        ${doc.generated_post ? `
          ${doc.generated_title ? `<div style="font-weight:600;margin-bottom:8px;color:var(--accent)">Suggested title: ${escapeHtml(doc.generated_title)}</div>` : ''}
          <textarea id="draft-content" rows="10">${escapeHtml(doc.generated_post)}</textarea>
          <div style="display:flex;gap:10px;margin-top:12px">
            <button class="btn btn-primary" onclick="sendToQueue(${doc.id})">Send to Posts Queue</button>
            <button class="btn btn-secondary" onclick="generateFromDoc(${doc.id})">Regenerate</button>
            <button class="btn btn-secondary" onclick="saveEditedDraft(${doc.id})">Save Edits</button>
          </div>
          <div style="font-size:0.72rem;color:var(--text-2);margin-top:8px;font-family:var(--font-mono)" id="draft-char-count">${doc.generated_post.length} chars</div>
        ` : '<p style="color:var(--text-2);font-size:0.84rem">Click the button above to generate a draft.</p>'}
      </div>
    </div>
  `;

  // Character count listener
  const ta = document.getElementById('draft-content');
  if (ta) {
    ta.addEventListener('input', () => {
      const cc = document.getElementById('draft-char-count');
      if (cc) cc.textContent = ta.value.length + ' chars';
    });
  }
}

async function saveThoughts(docId) {
  const thoughts = document.getElementById('doc-thoughts')?.value || '';
  try {
    await api(`/library/${docId}/thoughts`, { method: 'PUT', body: { thoughts } });
    toast('Thoughts saved', 'success');
  } catch (e) {
    toast(`Failed: ${e.message}`, 'error');
  }
}

async function generateFromDoc(docId) {
  const btn = document.getElementById('gen-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'Generating...'; }
  try {
    const result = await api(`/library/${docId}/generate`, { method: 'POST' });
    toast('Draft generated!', 'success');
    openLibraryDoc(docId);
  } catch (e) {
    toast(`Generation failed: ${e.message}`, 'error');
    if (btn) { btn.disabled = false; btn.textContent = 'Generate Post from Article + Thoughts'; }
  }
}

async function sendToQueue(docId) {
  try {
    const result = await api(`/library/${docId}/to-queue`, { method: 'POST' });
    toast(`Post #${result.post_id} added to queue!`, 'success');
    refreshSidebarStats();
  } catch (e) {
    toast(`Failed: ${e.message}`, 'error');
  }
}

async function saveEditedDraft(docId) {
  const content = document.getElementById('draft-content')?.value;
  if (!content) return;
  // We need a specific endpoint for this but we can use the generate endpoint's update
  // For now just toast that the user should use streamlit for this
  toast('Edits saved locally. Use Streamlit UI for full editing.', 'info');
}

async function deleteLibraryDoc(docId) {
  if (!confirm('Delete this document?')) return;
  try {
    await api(`/library/${docId}`, { method: 'DELETE' });
    toast('Document deleted', 'success');
    navigate('library');
  } catch (e) {
    toast(`Delete failed: ${e.message}`, 'error');
  }
}

function showAddDocModal() {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = `
    <div class="modal">
      <h3>Add Document</h3>
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="add-doc-title">
      </div>
      <div class="form-group">
        <label>Content</label>
        <textarea id="add-doc-content" rows="5"></textarea>
      </div>
      <div class="form-group">
        <label>Source URL (optional)</label>
        <input type="text" id="add-doc-source">
      </div>
      <div class="form-group">
        <label>Tags (comma-separated)</label>
        <input type="text" id="add-doc-tags">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-primary" onclick="submitAddDoc()">Add</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

async function submitAddDoc() {
  const title = document.getElementById('add-doc-title')?.value;
  const content = document.getElementById('add-doc-content')?.value;
  const source = document.getElementById('add-doc-source')?.value;
  const tagsStr = document.getElementById('add-doc-tags')?.value;
  if (!title || !content) { toast('Title and content required', 'error'); return; }
  const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(Boolean) : null;
  try {
    const result = await api('/library', { method: 'POST', body: { title, content, source: source || null, tags } });
    toast(`Document #${result.id} added`, 'success');
    document.querySelector('.modal-overlay')?.remove();
    navigate('library');
  } catch (e) {
    toast(`Failed: ${e.message}`, 'error');
  }
}

/* =============================================================
   POSTS QUEUE
   ============================================================= */
async function renderPosts(el) {
  const status = window._postsStatusFilter || 'draft';
  const posts = await api(`/posts?status=${status}`);

  el.innerHTML = `
    <div class="page-header">
      <h2>Posts Queue</h2>
      <p>Review, approve, edit, and publish generated posts</p>
    </div>

    <div class="filter-bar">
      <div class="filter-group">
        <label>Status</label>
        <select id="posts-status-filter" onchange="window._postsStatusFilter=this.value;navigate('posts')" style="width:160px">
          ${['draft','approved','published','rejected'].map(s => `<option value="${s}" ${s === status ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('')}
        </select>
      </div>
      <div style="font-size:0.78rem;color:var(--text-2);align-self:center">${posts.length} ${status} posts</div>
    </div>

    <div id="posts-container">
      ${posts.length ? posts.map((p, i) => renderPostCard(p, i)).join('') : `<div class="empty-state"><p>No ${status} posts found.</p></div>`}
    </div>
  `;
}

function renderPostCard(post, i) {
  const status = post.status || 'draft';
  let actions = '';

  if (status === 'draft') {
    actions = `
      <button class="btn btn-sm btn-success" onclick="updatePostStatus(${post.id},'approved')">Approve</button>
      <button class="btn btn-sm btn-danger" onclick="updatePostStatus(${post.id},'rejected')">Reject</button>
      <button class="btn btn-sm btn-secondary" onclick="editPost(${post.id})">Edit</button>
    `;
  } else if (status === 'approved') {
    actions = `
      <button class="btn btn-sm btn-primary" onclick="updatePostStatus(${post.id},'published')">Mark Published</button>
      <button class="btn btn-sm btn-secondary" onclick="editPost(${post.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="updatePostStatus(${post.id},'rejected')">Reject</button>
    `;
  } else if (status === 'published') {
    actions = `
      <button class="btn btn-sm btn-secondary" onclick="updatePostStatus(${post.id},'approved')">Repost</button>
      ${post.linkedin_url ? `<a href="${escapeHtml(safeUrl(post.linkedin_url))}" target="_blank" rel="noopener" class="btn btn-sm btn-secondary">View on LinkedIn</a>` : ''}
    `;
  } else if (status === 'rejected') {
    actions = `<button class="btn btn-sm btn-secondary" onclick="updatePostStatus(${post.id},'draft')">Move to Draft</button>`;
  }

  return `
    <div class="content-card" style="animation-delay:${Math.min(i * 0.03, 0.3)}s">
      <div class="content-card-header">
        <div class="content-card-meta">
          Strategy: <strong>${escapeHtml(post.strategy || 'N/A')}</strong> &middot; Created: ${escapeHtml(post.created_at || '')}
          ${post.published_at ? ` &middot; Published: ${escapeHtml(post.published_at)}` : ''}
        </div>
        <span class="${badgeClass(escapeHtml(status))}">${escapeHtml(status)}</span>
      </div>
      <div class="content-card-body">${escapeHtml(post.content || '')}</div>
      <div class="content-card-footer">
        ${actions}
        <span class="char-count">${(post.content || '').length} chars</span>
      </div>
    </div>
  `;
}

async function updatePostStatus(postId, status) {
  try {
    await api(`/posts/${postId}/status`, { method: 'PUT', body: { status } });
    toast(`Post #${postId} -> ${status}`, 'success');
    refreshSidebarStats();
    navigate('posts');
  } catch (e) {
    toast(`Failed: ${e.message}`, 'error');
  }
}

async function editPost(postId) {
  const post = await api(`/posts/${postId}`);
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = `
    <div class="modal">
      <h3>Edit Post #${postId}</h3>
      <div class="form-group">
        <label>Content</label>
        <textarea id="edit-post-content" rows="12">${escapeHtml(post.content || '')}</textarea>
      </div>
      <div style="font-size:0.76rem;color:var(--text-2);font-family:var(--font-mono)" id="edit-char-count">${(post.content||'').length} chars</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-primary" onclick="savePostEdit(${postId})">Save</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  const ta = document.getElementById('edit-post-content');
  ta?.addEventListener('input', () => {
    document.getElementById('edit-char-count').textContent = ta.value.length + ' chars';
  });
}

async function savePostEdit(postId) {
  const content = document.getElementById('edit-post-content')?.value;
  if (!content) return;
  try {
    await api(`/posts/${postId}/content`, { method: 'PUT', body: { content } });
    toast('Post updated', 'success');
    document.querySelector('.modal-overlay')?.remove();
    navigate('posts');
  } catch (e) {
    toast(`Save failed: ${e.message}`, 'error');
  }
}

/* =============================================================
   COMMENTS
   ============================================================= */
async function renderComments(el) {
  const status = window._commentsStatusFilter || 'draft';
  const comments = await api(`/comments?status=${status}`);

  el.innerHTML = `
    <div class="page-header">
      <h2>Comments</h2>
      <p>Review and manage generated comments</p>
    </div>

    <div class="filter-bar">
      <div class="filter-group">
        <label>Status</label>
        <select id="comments-status-filter" onchange="window._commentsStatusFilter=this.value;navigate('comments')" style="width:160px">
          ${['draft','approved','published','rejected'].map(s => `<option value="${s}" ${s === status ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('')}
        </select>
      </div>
      <div style="font-size:0.78rem;color:var(--text-2);align-self:center">${comments.length} ${status} comments</div>
      ${status === 'draft' && comments.length ? `<button class="btn btn-success btn-sm" onclick="approveAllDrafts()">Approve All Drafts</button>` : ''}
    </div>

    <div id="comments-container">
      ${comments.length ? comments.map((c, i) => renderCommentCard(c, i)).join('') : `<div class="empty-state"><p>No ${status} comments found.</p></div>`}
    </div>
  `;
}

function renderCommentCard(comment, i) {
  const status = comment.status || 'draft';
  let actions = '';

  if (status === 'draft') {
    actions = `
      <button class="btn btn-sm btn-success" onclick="updateCommentStatus(${comment.id},'approved')">Approve</button>
      <button class="btn btn-sm btn-danger" onclick="updateCommentStatus(${comment.id},'rejected')">Reject</button>
      <button class="btn btn-sm btn-secondary" onclick="editComment(${comment.id})">Edit</button>
    `;
  } else if (status === 'approved') {
    actions = `
      <button class="btn btn-sm btn-secondary" onclick="editComment(${comment.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="updateCommentStatus(${comment.id},'rejected')">Reject</button>
    `;
  } else if (status === 'published') {
    actions = `<button class="btn btn-sm btn-secondary" onclick="updateCommentStatus(${comment.id},'approved')">Repost</button>`;
  } else if (status === 'rejected') {
    actions = `<button class="btn btn-sm btn-secondary" onclick="updateCommentStatus(${comment.id},'draft')">Move to Draft</button>`;
  }

  return `
    <div class="content-card" style="animation-delay:${Math.min(i * 0.03, 0.3)}s">
      <div class="content-card-header">
        <div class="content-card-meta">
          Strategy: <strong>${escapeHtml(comment.strategy || 'N/A')}</strong>
          &middot; Confidence: <strong>${((comment.confidence || 0) * 100).toFixed(0)}%</strong>
          &middot; ${escapeHtml(comment.created_at || '')}
        </div>
        <span class="${badgeClass(escapeHtml(status))}">${escapeHtml(status)}</span>
      </div>
      ${comment.target_post_content ? `
        <div style="background:var(--bg-3);border-radius:var(--radius-sm);padding:12px;margin-bottom:12px;font-size:0.82rem">
          <div style="color:var(--text-2);margin-bottom:4px;font-size:0.72rem;text-transform:uppercase;letter-spacing:0.06em">Target Post by ${escapeHtml(comment.target_post_author || 'Unknown')}</div>
          <div style="color:var(--text-1)">${truncate(escapeHtml(comment.target_post_content), 250)}</div>
          ${comment.target_post_url ? `<a href="${escapeHtml(safeUrl(comment.target_post_url))}" target="_blank" rel="noopener" style="font-size:0.72rem;margin-top:6px;display:inline-block">View on LinkedIn</a>` : ''}
        </div>
      ` : ''}
      <div style="font-weight:500;margin-bottom:14px;font-size:0.9rem;color:var(--text-0);line-height:1.6">${escapeHtml(comment.comment_content || '')}</div>
      <div class="content-card-footer">${actions}</div>
    </div>
  `;
}

async function updateCommentStatus(commentId, status) {
  try {
    await api(`/comments/${commentId}/status`, { method: 'PUT', body: { status } });
    toast(`Comment #${commentId} -> ${status}`, 'success');
    navigate('comments');
  } catch (e) {
    toast(`Failed: ${e.message}`, 'error');
  }
}

async function approveAllDrafts() {
  try {
    const result = await api('/comments/approve-all', { method: 'POST' });
    toast(`Approved ${result.count} comments`, 'success');
    navigate('comments');
  } catch (e) {
    toast(`Failed: ${e.message}`, 'error');
  }
}

async function editComment(commentId) {
  const comment = await api(`/comments/${commentId}`);
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = `
    <div class="modal">
      <h3>Edit Comment #${commentId}</h3>
      <div class="form-group">
        <label>Comment</label>
        <textarea id="edit-comment-content" rows="6">${escapeHtml(comment.comment_content || '')}</textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCommentEdit(${commentId})">Save</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

async function saveCommentEdit(commentId) {
  const content = document.getElementById('edit-comment-content')?.value;
  if (!content) return;
  try {
    await api(`/comments/${commentId}/content`, { method: 'PUT', body: { content } });
    toast('Comment updated', 'success');
    document.querySelector('.modal-overlay')?.remove();
    navigate('comments');
  } catch (e) {
    toast(`Save failed: ${e.message}`, 'error');
  }
}

/* =============================================================
   ANALYTICS
   ============================================================= */
async function renderAnalytics(el) {
  const data = await api('/analytics');

  const statusData = data.posts.by_status || {};
  const actionData = data.actions_7d || {};
  const maxStatus = Math.max(...Object.values(statusData), 1);
  const maxAction = Math.max(...Object.values(actionData), 1);

  el.innerHTML = `
    <div class="page-header">
      <h2>Analytics</h2>
      <p>Content performance and activity overview</p>
    </div>

    <div class="card-grid card-grid-3" style="margin-bottom:28px">
      <div class="card metric-card accent">
        <div class="metric-value">${data.posts.total || 0}</div>
        <div class="metric-label">Total Posts</div>
      </div>
      <div class="card metric-card success">
        <div class="metric-value">${data.posts.published || 0}</div>
        <div class="metric-label">Published</div>
      </div>
      <div class="card metric-card info">
        <div class="metric-value">${data.posts.approval_rate || 'N/A'}</div>
        <div class="metric-label">Approval Rate</div>
      </div>
    </div>

    <div class="card-grid card-grid-2" style="margin-bottom:28px">
      <div class="card">
        <h3 style="font-family:var(--font-heading);font-size:1.1rem;margin-bottom:16px">Post Status Breakdown</h3>
        ${Object.keys(statusData).length ? `
          <div class="bar-chart">
            ${Object.entries(statusData).map(([status, count]) => `
              <div class="bar-col">
                <div class="bar-value">${count}</div>
                <div class="bar" style="height:${(count/maxStatus)*100}%;background:var(--accent-muted);border-color:var(--border-accent)"></div>
                <div class="bar-label">${escapeHtml(status)}</div>
              </div>
            `).join('')}
          </div>
        ` : '<p style="color:var(--text-2);font-size:0.84rem">No data yet.</p>'}
      </div>

      <div class="card">
        <h3 style="font-family:var(--font-heading);font-size:1.1rem;margin-bottom:16px">Actions (7 Days)</h3>
        ${Object.keys(actionData).length ? `
          <div class="bar-chart">
            ${Object.entries(actionData).map(([action, count]) => `
              <div class="bar-col">
                <div class="bar-value">${count}</div>
                <div class="bar" style="height:${(count/maxAction)*100}%;background:var(--info-bg);border-color:rgba(96,165,250,0.2)"></div>
                <div class="bar-label">${escapeHtml(action.replace(/_/g, ' '))}</div>
              </div>
            `).join('')}
          </div>
        ` : '<p style="color:var(--text-2);font-size:0.84rem">No actions recorded.</p>'}
      </div>
    </div>

    <div class="card">
      <h3 style="font-family:var(--font-heading);font-size:1.1rem;margin-bottom:16px">Recent Activity</h3>
      <div style="max-height:400px;overflow-y:auto">
        ${(data.recent_activity || []).map(l => `
          <div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:0.8rem;display:flex;gap:12px;align-items:center">
            <span style="color:${l.status==='success' ? 'var(--success)' : 'var(--error)'};font-weight:700;width:18px;text-align:center">${l.status === 'success' ? '+' : 'x'}</span>
            <span style="color:var(--text-2);font-family:var(--font-mono);font-size:0.72rem;white-space:nowrap">${escapeHtml(l.created_at || '')}</span>
            <span style="color:var(--text-0);font-weight:500">${escapeHtml(l.action_type)}</span>
            <span style="color:var(--text-2);flex:1">${escapeHtml(l.details || '')}</span>
          </div>
        `).join('') || '<p style="color:var(--text-2)">No activity.</p>'}
      </div>
    </div>
  `;
}

/* =============================================================
   SETTINGS
   ============================================================= */
async function renderSettings(el) {
  const settings = await api('/settings');

  el.innerHTML = `
    <div class="page-header">
      <h2>Settings</h2>
      <p>Configuration overview (edit config/config.yaml to change)</p>
    </div>

    <div class="card-grid card-grid-2" style="margin-bottom:20px">
      <div class="card">
        <h3 style="font-family:var(--font-heading);font-size:1.1rem;margin-bottom:16px">AI Provider</h3>
        ${settingRow('Provider', settings.ai.provider)}
        ${settingRow('Model', settings.ai.model)}
        ${settingRow('API Key', settings.ai.api_key_status)}
      </div>

      <div class="card">
        <h3 style="font-family:var(--font-heading);font-size:1.1rem;margin-bottom:16px">LinkedIn</h3>
        ${settingRow('Account', settings.linkedin.email)}
        ${settingRow('Headless', String(settings.linkedin.headless))}
      </div>
    </div>

    <div class="card-grid card-grid-2" style="margin-bottom:20px">
      <div class="card">
        <h3 style="font-family:var(--font-heading);font-size:1.1rem;margin-bottom:16px">Scheduling</h3>
        ${settingRow('Timezone', settings.scheduling.timezone)}
        ${settingRow('Post Hours', settings.scheduling.posts_cron_hour)}
        ${settingRow('Max Posts/Day', String(settings.scheduling.posts_max_per_day))}
        ${settingRow('Comment Interval', settings.scheduling.comments_interval + 'h')}
        ${settingRow('Active Hours', settings.scheduling.comments_active_hours)}
        ${settingRow('Max Comments/Day', String(settings.scheduling.comments_max_per_day))}
      </div>

      <div class="card">
        <h3 style="font-family:var(--font-heading);font-size:1.1rem;margin-bottom:16px">Safety Limits</h3>
        ${settingRow('Hourly', String(settings.safety.hourly))}
        ${settingRow('Daily', String(settings.safety.daily))}
        ${settingRow('Weekly', String(settings.safety.weekly))}
        ${settingRow('Error Threshold', (settings.safety.error_threshold * 100).toFixed(0) + '%')}
        ${settingRow('Cooldown', settings.safety.cooldown_minutes + ' min')}
      </div>
    </div>

    <div class="card" style="background:var(--info-bg);border-color:rgba(96,165,250,0.15)">
      <p style="font-size:0.84rem;color:var(--info)">To change settings, edit <code style="font-family:var(--font-mono);background:rgba(96,165,250,0.1);padding:2px 6px;border-radius:3px">config/config.yaml</code> and <code style="font-family:var(--font-mono);background:rgba(96,165,250,0.1);padding:2px 6px;border-radius:3px">.env</code>, then restart the app.</p>
    </div>
  `;
}

function settingRow(label, value) {
  return `
    <div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);font-size:0.82rem">
      <span style="color:var(--text-2)">${label}</span>
      <span style="color:var(--text-0);font-family:var(--font-mono);font-size:0.78rem">${escapeHtml(value)}</span>
    </div>
  `;
}

/* =============================================================
   INIT
   ============================================================= */
document.addEventListener('DOMContentLoaded', () => {
  navigate('dashboard');
  refreshSidebarStats();
  // Refresh stats every 30s
  setInterval(refreshSidebarStats, 30000);
});
</script>
</body>
</html>
